<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<title>מבחן ריכוז - עם השהיית פספוסים לטלפון</title>
<style>
  body {
    text-align: center;
    font-family: Arial, sans-serif;
    background: #f0f0f0;
    direction: rtl;
    user-select: none; /* כדי למנוע בחירה בטעות בטלפון */
    -webkit-tap-highlight-color: transparent; /* מניעת הדגשה בכפתור במובייל */
  }
  canvas {
    border: 2px solid #333;
    background: white;
    margin-top: 20px;
    touch-action: manipulation; /* כדי למנוע גלילה בטעות במגע */
  }
  #stats {
    margin-top: 15px;
    font-size: 18px;
  }
  #feedback {
    position: absolute;
    top: 20px;
    left: 20px;
    font-size: 40px;
    font-weight: bold;
    user-select: none;
  }
</style>
</head>
<body>

<h1>לחץ או גע במסך רק כשמופיע עיגול ירוק</h1>
<canvas id="canvas" width="400" height="400"></canvas>
<div id="stats">
  <p>זמן שנותר: <span id="timeLeft">180</span> שניות</p>
</div>
<div id="feedback"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const feedback = document.getElementById("feedback");

const shapes = ["circle", "square", "triangle", "ellipse"];
const colors = ["green", "black", "red", "blue"];

let timeLeft = 180;
let targetShape = "circle";
let targetColor = "green";
let currentShape = "";
let currentColor = "";
let testInterval;
let shapeTimeout;

let correct = 0;
let wrong = 0;
let missed = 0;
let totalTargets = 0;
let paused = false;

let reactionTimes = [];
let shapeAppearTime = 0;
let targetActive = false;
let reactedThisRound = false;

function drawShape(shape, color) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = color;
  ctx.strokeStyle = color;
  ctx.lineWidth = 3;
  ctx.beginPath();

  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;

  if (shape === "circle") {
    ctx.arc(centerX, centerY, 80, 0, Math.PI * 2);
    ctx.fill();
  } else if (shape === "square") {
    ctx.fillRect(centerX - 80, centerY - 80, 160, 160);
  } else if (shape === "triangle") {
    ctx.moveTo(centerX, centerY - 90);
    ctx.lineTo(centerX - 80, centerY + 80);
    ctx.lineTo(centerX + 80, centerY + 80);
    ctx.closePath();
    ctx.fill();
  } else if (shape === "ellipse") {
    ctx.ellipse(centerX, centerY, 100, 60, 0, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.closePath();
}

function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function showFeedback(symbol, color, duration) {
  feedback.style.color = color;
  feedback.textContent = symbol;
  setTimeout(() => {
    feedback.textContent = "";
  }, duration);
}

function showRandomShape() {
  if (paused) return;

  if (targetActive && !reactedThisRound) {
    missed++;
    showFeedback("❌", "red", 1000);
  }

  const randomChance = Math.random();
  let isNextTarget = false;

  if (randomChance < 0.20) {
    currentShape = "circle";
    currentColor = "green";
    targetActive = true;
    totalTargets++;
    isNextTarget = true;
  } else if (randomChance < 0.35) {
    currentShape = "ellipse";
    currentColor = "green";
    targetActive = false;
  } else {
    currentShape = shapes[Math.floor(Math.random() * shapes.length)];
    currentColor = colors[Math.floor(Math.random() * colors.length)];
    targetActive = false;
  }

  reactedThisRound = false;
  drawShape(currentShape, currentColor);
  shapeAppearTime = performance.now();

  let delay = 1000;
  if (isNextTarget) delay += 150; // השהייה של 0.15 שניות בין שני עיגולים ירוקים

  clearTimeout(shapeTimeout);
  shapeTimeout = setTimeout(showRandomShape, delay);
}

// פונקציה שתטפל בלחיצה/נגיעה במסך
function handleUserAction() {
  if (paused) return; // לא להגיב אם אנחנו בהשהייה

  const reactionTime = (performance.now() - shapeAppearTime) / 1000;
  reactedThisRound = true;

  if (currentShape === targetShape && currentColor === targetColor) {
    correct++;
    reactionTimes.push(reactionTime);
    showFeedback("⚪", "green", 500);

    // מחביאים את הצורה ונותנים השהייה 150 מ"ש לפני הצורה הבאה
    paused = true;
    clearTimeout(shapeTimeout);
    clearCanvas();

    setTimeout(() => {
      paused = false;
      showRandomShape();
    }, 150);

  } else {
    wrong++;
    showFeedback("❌", "red", 1000);
  }
}

document.addEventListener("keydown", (event) => {
  if (event.code === "Space") {
    event.preventDefault();
    handleUserAction();
  }
});

// תומך בנגיעה במסך - גם למובייל וגם לדסקטופ במצב מגע
canvas.addEventListener("touchstart", (e) => {
  e.preventDefault();
  handleUserAction();
});

canvas.addEventListener("mousedown", (e) => {
  e.preventDefault();
  handleUserAction();
});

function calculateScore() {
  if (totalTargets === 0) return { score: 1, avgReaction: 0 };

  let accuracy = correct / totalTargets;
  let avgReaction = reactionTimes.length > 0 ?
    reactionTimes.reduce((a, b) => a + b) / reactionTimes.length : 1;

  let score = accuracy * 5;
  score -= wrong * 0.7;
  score -= missed * 1;

  if (avgReaction > 0.6) score -= 1;
  if (avgReaction < 0.3) score -= 1;

  score = Math.max(1, Math.min(5, Math.round(score)));

  return { score, avgReaction };
}

function startTest() {
  showRandomShape();
  testInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timeLeft").textContent = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(testInterval);
      clearTimeout(shapeTimeout);

      if (targetActive && !reactedThisRound) {
        missed++;
      }

      let result = calculateScore();
      alert(
        `הסתיים המבחן!\n` +
        `נכונות: ${correct}\n` +
        `טעויות: ${wrong}\n` +
        `פספוסים: ${missed}\n` +
        `זמן תגובה ממוצע: ${result.avgReaction.toFixed(3)} שניות\n` +
        `ציון: ${result.score} מתוך 5`
      );
    }
  }, 1000);
}

startTest();
</script>

</body>
</html>
